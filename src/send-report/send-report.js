const AccountModel = require("../models/account.model");
const UserModel = require("../models/user.model");
const moment = require("moment");

const sendReport = async ({
  bot,
  startText,
  siteName,
  limit,
  searchWords,
  mode,
}) => {
  const users = await UserModel.find();
  for (const user of users) {
    if (user.sendInfo) {
      let text = startText;

      const accounts = await AccountModel.find({
        siteName,
        mode: mode,
      })
        .sort({ date: "desc" })
        .limit(limit);

      if (accounts && accounts.length) {
        searchWords.forEach((word) => {
          const filteredSortedData = accounts
            .filter((result) => result.name === word)
            .sort((a, b) => moment(a.date).unix() - moment(b.date).unix());
          if (filteredSortedData.length) {
            text += `\n–ù–∞ ${moment(filteredSortedData[0].date).format(
              "YYYY MM DD HH:mm"
            )}. ‚úÖ \n–ù–∞ –ø–ª–æ—â–∞–¥–∫–µ –ø—Ä–æ–¥–∞–µ—Ç—Å—è ${
              filteredSortedData[0].total
            } –∞–∫–∫–∞—É–Ω—Ç–æ–≤ ${
              filteredSortedData[0].name
            }. üë§\n–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç —Ç–∏–ø–∞ ${
              filteredSortedData[0].name
            } —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${
              filteredSortedData[0].lowestPrice
            } US$D. üí≤\n–ù–∏–∫–Ω–µ–π–º –¥–µ–º–ø–µ—Ä–∞: ${
              filteredSortedData[0].lowestUser.username.split("\n").length > 1
                ? filteredSortedData[0].lowestUser.username.split("\n")[1]
                : filteredSortedData[0].lowestUser.username.split("\n")
            }. üë§\n–ù–∞–∑–≤–∞–Ω–∏–µ –ª–æ—Ç–∞:  ${filteredSortedData[0].lowestTitle}.  \n`;

            if (filteredSortedData[1]) {
              const daysDiff = moment(filteredSortedData[1].date).diff(
                moment(filteredSortedData[0].date),
                "days"
              );
              const hoursDiff = moment(filteredSortedData[1].date).diff(
                moment(filteredSortedData[0].date),
                "hours"
              );
              const minutesDiff = moment(filteredSortedData[1].date).diff(
                moment(filteredSortedData[0].date),
                "minutes"
              );
              const secondsDiff = moment(filteredSortedData[1].date).diff(
                moment(filteredSortedData[0].date),
                "seconds"
              );
              const difference =
                filteredSortedData[1].total - filteredSortedData[0].total;
              text += `–û—Ç –ø—Ä–µ–¥—ã–¥—â–µ–≥–æ –∑–∞–º–µ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ - ${
                difference === 0
                  ? "–Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å"
                  : difference > 0
                  ? `—É–º–µ–Ω—å—à–∏–ª–æ—Å—å –Ω–∞ ${Math.abs(difference)}`
                  : `—É–≤–µ–ª–∏—á–∏–ª–æ—Å—å –Ω–∞ ${Math.abs(difference)}`
              }.\n–ü—Ä–µ–¥—ã–¥—â–∏–π –∑–∞–º–µ—Ä –±—ã–ª: ${
                daysDiff > 30 ? daysDiff % 30 : daysDiff
              } –¥–Ω–µ–π, ${hoursDiff > 24 ? hoursDiff % 24 : hoursDiff}  —á–∞—Å–æ–≤, ${
                minutesDiff > 60 ? minutesDiff % 60 : minutesDiff
              }  –º–∏–Ω—É—Ç, ${
                secondsDiff > 60 ? secondsDiff % 60 : secondsDiff
              }  —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥.\n`;
            }
          }
        });
      } else {
        text += "‚ö†Ô∏è–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ‚ö†Ô∏è";
      }
      await bot.telegram.sendMessage(user.chatId, text);
    }
  }
};

module.exports = { sendReport };
